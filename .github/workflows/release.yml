name: Release & Deploy

on:
    push:
        branches:
            - staging
            - main

env:
    IMAGE_NAME: ghcr.io/armandwipangestu/my-first-npm-package

jobs:
    # ------------------------------------------------------
    # JOB 1 - BUILD DOCKER IMAGE USING COMMIT SHA (HASH)
    # ------------------------------------------------------
    build-docker-sha:
        name: Build Docker Image Using Commit SHA
        runs-on: ubuntu-latest
        permissions:
            contents: write
            issues: write
            pull-requests: write
        environment: ${{ github.ref_name }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Extract commit SHA
              id: sha
              run: echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

            - name: Log in to GitHub Container Registry
              run: echo "${{ secrets.GH_TOKEN }}" | docker login ghcr.io -u "${{ secrets.GH_USERNAME }}" --password-stdin

            - name: Build Docker Image with SHA tag
              run: |
                  docker build \
                    -f Dockerfile \
                    -t $IMAGE_NAME:${{ env.SHORT_SHA }} .

            - name: Push Docker Image (SHA tag)
              run: docker push $IMAGE_NAME:${{ env.SHORT_SHA }}

            - name: Save SHA to file
              run: echo "${SHORT_SHA}" > sha.txt

            - name: Upload SHA artifact
              uses: actions/upload-artifact@v4
              with:
                  name: built-sha
                  path: sha.txt

    # ------------------------------------------------------
    # JOB 2 - SEMANTIC RELEASE
    # ------------------------------------------------------
    release-and-tagging-version:
        name: Release and Tagging Version
        runs-on: ubuntu-latest
        # needs: build-docker-sha
        permissions:
            contents: write
            issues: write
            pull-requests: write
            id-token: write # Mandatory for OIDC and Granular Tokens
            packages: write # Required to push to GitHub Packages
        environment: ${{ github.ref_name }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js for Semantic Release
              uses: actions/setup-node@v4
              with:
                  node-version: "25"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci # This installs everything in devDependencies fast

            - name: Run semantic-release (Publishes to npmjs.org)
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  NPM_TOKEN: ${{ secrets.NPM_TOKEN }} # For npmjs.org registry
              run: npx semantic-release

            - name: Publish to GitHub Packages registry
              if: hashFiles('version.txt') != '' # Only runs if a version was actually created
              run: |
                  # 1. Point npm to GitHub Registry          
                  echo "@armandwipangestu:registry=https://npm.pkg.github.com/" > .npmrc

                  # 2. Set the auth token for GitHub
                  echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> .npmrc

                  # 3. Publish (using --access public if your repo is public)
                  npm publish --access public --tag ${{ github.ref_name == 'main' && 'latest' || github.ref_name }} --registry=https://npm.pkg.github.com/
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Upload version.txt artifact
              uses: actions/upload-artifact@v4
              with:
                  name: release-version
                  path: version.txt

    # ------------------------------------------------------
    # JOB 3 - RETAG IMAGE: SHA -> VERSION -> LATEST
    # ------------------------------------------------------
    retag-and-push:
        name: Retag and Push Docker Image
        runs-on: ubuntu-latest
        needs:
            - build-docker-sha
            - release-and-tagging-version
        permissions:
            contents: write
            issues: write
            pull-requests: write
            packages: write
        environment: ${{ github.ref_name }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Download version.txt artifact
              uses: actions/download-artifact@v4
              with:
                  name: release-version
              continue-on-error: true # Prevents crash if no release happened

            - name: Check if version exists
              id: check-version
              run: |
                  if [ -f "version.txt" ]; then
                      echo "VERSION=$(cat version.txt)" >> $GITHUB_ENV
                      echo "RELEASE_EXISTS=true" >> $GITHUB_OUTPUT
                  else
                      echo "No new version released. Skipping retag."
                      echo "RELEASE_EXISTS=false" >> $GITHUB_OUTPUT
                  fi

            - name: Download sha.txt artifact
              if: steps.check-version.outputs.RELEASE_EXISTS == 'true'
              uses: actions/download-artifact@v4
              with:
                  name: built-sha

            - name: Set SHORT_SHA env
              if: steps.check-version.outputs.RELEASE_EXISTS == 'true'
              run: echo "SHORT_SHA=$(cat sha.txt)" >> $GITHUB_ENV

            - name: Log in to GitHub Container Registry
              if: steps.check-version.outputs.RELEASE_EXISTS == 'true'
              run: echo "${{ secrets.GH_TOKEN }}" | docker login ghcr.io -u "${{ secrets.GH_USERNAME }}" --password-stdin

            - name: Retag and Push
              if: steps.check-version.outputs.RELEASE_EXISTS == 'true'
              run: |
                  docker pull $IMAGE_NAME:${{ env.SHORT_SHA }}
                  docker tag $IMAGE_NAME:${{ env.SHORT_SHA }} $IMAGE_NAME:${{ env.VERSION }}
                  docker push $IMAGE_NAME:${{ env.VERSION }}

            - name: Retag latest (only on main)
              if: steps.check-version.outputs.RELEASE_EXISTS == 'true' && github.ref_name == 'main'
              run: |
                  docker tag $IMAGE_NAME:${{ env.VERSION }} $IMAGE_NAME:latest
                  docker push $IMAGE_NAME:latest
